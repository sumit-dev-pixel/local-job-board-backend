<!DOCTYPE html>
<html>
<head>
    <title>Apply Job</title>
    <link rel="stylesheet" href="Apply.css">
</head>
<body>

<h2>Apply for Job</h2>

<form id="applyForm">
    
    <input type="hidden" id="job_id">

    <label>Name:</label><br>
    <input type="text" id="name" required><br><br>

    <label>Email:</label><br>
    <input type="email" id="email" required><br><br>

    <label>Phone:</label><br>
    <input type="text" id="phone" required><br><br>

    <label>Resume (Link):</label><br>
    <input type="url" id="resume" placeholder="Paste your resume link"><br><br>

    <button type="submit">Submit Application</button>
</form>

<script>

// ================= LOGIN + ROLE PROTECTION =================
const seeker_id = localStorage.getItem("user_id");
const role = localStorage.getItem("role");

if (!seeker_id || role !== "seeker") {
    alert("Please login as Job Seeker first!");
    window.location.href = "login.html";
}

// ================= GET JOB ID =================
const urlParams = new URLSearchParams(window.location.search);
const jobId = urlParams.get('job_id');

if (!jobId) {
    alert("Invalid Job!");
    window.location.href = "find-job.html";
}

document.getElementById('job_id').value = jobId;


// ================= APPLY FORM SUBMIT =================
document.getElementById('applyForm').addEventListener('submit', function(e){
    e.preventDefault();

    fetch("http://localhost:3000/apply", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            job_id: jobId,
            seeker_id: seeker_id,  // now guaranteed not null
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            resume: document.getElementById('resume').value
        })
    })
    .then(res => res.json())
    .then(data => {

        alert(data.message);

        if(data.message === "Application saved successfully"){
            window.location.href = "find-job.html";
        }

    })
    .catch(err => {
        alert("Something went wrong!");
        console.log(err);
    });

});

</script>

</body>
</html>